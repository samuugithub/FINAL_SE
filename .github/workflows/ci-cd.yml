name: Project CI (Backend + Frontend + ML)

on:
  push:
    paths:
      - "SE_PROJECT_1/"
      - ".github/workflows/frontend-ci.yml"

  pull_request:
    paths:
      - "SE_PROJECT_1/"
      - ".github/workflows/frontend-ci.yml"

jobs:
  ci:
    runs-on: windows-latest

    steps:

    # -----------------------------------
    # 1. CHECKOUT CODE
    # -----------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------------
    # 2. SETUP PYTHON
    # -----------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # -----------------------------------
    # 3. INSTALL BACKEND DEPENDENCIES
    # -----------------------------------
    - name: Install backend dependencies
      run: |
        cd SE_PROJECT_1/backend
        if (Test-Path requirements.txt) {
            pip install -r requirements.txt
        }

    # -----------------------------------
    # 4. INSTALL FRONTEND DEPENDENCIES
    # -----------------------------------
    - name: Install frontend dependencies
      run: |
        pip install streamlit

    # -----------------------------------
    # 5. LINT (Flake8 + Pylint + Report)
    # -----------------------------------
    - name: Run flake8 and pylint
      run: |
        pip install flake8 pylint
        flake8 SE_PROJECT_1 --exclude _pycache_ || true
        pylint SE_PROJECT_1/backend/*.py --exit-zero > pylint-report.txt

    - name: Upload Lint Report
      uses: actions/upload-artifact@v4
      with:
        name: lint-report
        path: pylint-report.txt

    # -----------------------------------
    # 6. RUN TESTS + COVERAGE
    # -----------------------------------
    - name: Run pytest with coverage
      run: |
        pip install pytest pytest-cov
        pytest --cov=SE_PROJECT_1 --cov-report=html || true

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/

    # -----------------------------------
    # 7. SECURITY SCAN (Bandit)
    # -----------------------------------
    - name: Security Scan using Bandit
      run: |
        pip install bandit
        bandit -r SE_PROJECT_1 -f json -o bandit-report.json || true

    - name: Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json

    # -----------------------------------
    # 8. VERIFY ML MODEL FILE
    # -----------------------------------
    - name: Check ML model presence
      run: |
        if (!(Test-Path "SE_PROJECT_1/backend/model.pkl")) {
            Write-Error "model.pkl NOT FOUND!"
        } else {
            Write-Output "model.pkl found."
        }

    # -----------------------------------
    # 9. BACKEND HEALTH CHECK
    # -----------------------------------
    - name: Backend basic check
      run: |
        cd SE_PROJECT_1/backend
        python app.py --help || true

    # -----------------------------------
    # 10. FRONTEND HEALTH CHECK
    # -----------------------------------
    - name: Streamlit health check
      run: |
        streamlit --version

    # -----------------------------------
    # 11. CREATE FULL PROJECT ZIP ARTIFACT
    # -----------------------------------
    - name: Create build artifact
      run: |
        powershell Compress-Archive -Path SE_PROJECT_1 -DestinationPath project-build.zip

    # -----------------------------------
    # 12. UPLOAD FINAL ARTIFACT
    # -----------------------------------
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: full-project-build
        path: project-build.zip
